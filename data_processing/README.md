# Data processing pipeline

This directory contains a collection of scripts that are used to process the data for the map widget.

These scripts are here to document the process and to make it easier to reproduce the data, but there is no guarantee that they will work out of the box.

## Data sources

You need to download GTFS feed for Germany provided by DELFI. The feed is available at [opendata-oepnv.de](https://www.opendata-oepnv.de/ht/de/organisation/delfi/startseite?tx_vrrkit_view%5Bdataset_name%5D=deutschlandweite-sollfahrplandaten-gtfs&tx_vrrkit_view%5Baction%5D=details&tx_vrrkit_view%5Bcontroller%5D=View). The feed is updated weekly. Currently in use is the feed from 2023-01-09.

Other data sources (shared for convenience):

- `gemeinden_be_bb_geo.json`: GeoJSON file with "Gemeinden" of Berlin/Brandenburg
- `germany.geojson`: GeoJSON for Germany
- `Public-Transport-2023-cities.csv`: city centres, maintained as [Google doc](https://docs.google.com/spreadsheets/d/1h8zNhIWaNxpXlZ5jsy_0tZdJxZ-Evlx7uqfuPEkbIdQ/edit#gid=1089886967)

## Results

Data produced by these scripts can be downloaded from the ARD-ZDF-Box folder `Public_Transport_2023`. A description of each file can be found below.

### Intermediate files

Stored in `Public_Transport_2023/intermediate`

- `blacklist_ids.txt`: List of blacklisted stops that are excluded from analysis (generated by `03_delfi_blacklist.R`)
- `rename.csv`: List of stops to be renamed for the analysis (generated by `03_delfi_blacklist.R`)
- `stops.json`: List of stops and their municipality (generated by `04_statting.py`)
- `stops_with_coords.json`: List of stops and their municipality, including coordinates (generated by `04_statting.py`)
- `new_transfers.csv`: transfers for stops within walking distance (generated by `05_transferring.py`)
- `new_transfers_same_name.csv`: transfers for stops with the same name (generated by `05_transferring.py`)
- `faulty_transfers.csv`: faulty transfers (generated by `06_teleporting.py`)
- `20230109_preprocessed.zip`: new GTFS feed that applies all pre-processing steps to the data (generated by `07_prepping.py`)
- `dead_stations.csv`: list of stops that fail to reach any city centre station within an hour
- `dead_stations.geojson`: same as `dead_stations.csv` with geo data

## Output files

Stored in `Public_Transport_2023/output`

- `journeys.json`: list of stops and their journeys to nearby city centres (generated by `16_merge.py`). Each entry has a field `stopInfo` (with general information including the stop's id, name, municipality and its coordinates) and a field `travelTimes` with entries for Werktag/Samstag/Sonntag and Tag/Nacht. One entry describes the journey from the stop in question to the main station of a city centre, with fields `id` (stop id of the city centre station), `name` (name of the city centre station), `time` (duration in seconds), `trans` (number of transitions) and `coord` (coordinates of the city centre station). Some have an additional field `walking` set to true if no public transport connection could be found but the destination is within walking distance.

## Other files, shared for convenience

Stored in `Public_Transport_2023/other`

- `city-centre-stations.geojson`: City centres in GeoJSON format
- `stops.geojson`: All stops in Berlin/Brandenburg (and Poland) in GeoJSON format
